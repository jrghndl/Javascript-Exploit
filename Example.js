
let photoExploit = {
    exploitCanvas: document.createElement('canvas'),
    //Loads an imagine into the canvas object.
    loadImage: function(uri){
        let img = new Image;
        img.onload = function(){
            photoExploit.exploitContext.drawImage(img,0,0); 
        };
        img.src = uri;
    },
    //When on is called, it replaces getImageData with the custom function.
    on: function(){
        CanvasRenderingContext2D.prototype.__oldGetImageData = CanvasRenderingContext2D.prototype.getImageData;
        CanvasRenderingContext2D.prototype.getImageData = function(x, y, w, h){
            if (photoExploit.photoCaptureFunc_Found){
                //In case the game modifies the prototype of the function, it checks for a portion of the code unique to this function.
                let funcString = arguments.callee.caller.toString().replace(/[a-zA-Z_ ]/g, '');
                if(arguments.callee.caller.name = photoExploit.photoCaptureFunc_Name){
                    if(funcString.includes('100,50,500,0,300,200')){
                        //If the target function has called getImageData, then it calls the original getImageData function using our exploitCanvas and returns the results.
                        return photoExploit.exploitContext.__oldGetImageData(0, 0, w, h);
                    } else {
                        //If not the target function, then it calls the original getImageData using the original arguments passed by the calling function.
                        return CanvasRenderingContext2D.prototype.__oldGetImageData.apply(this, arguments);
                    }
                }
            } else { //If the correct function within the anonymous function has not been called once before, then this runs.
                //The function its looking for is obfuscated. This obfuscation method only randomizes function names with underscores, lowercase, uppercase characters.
                //Therefore, regex is used to remove all lowercase letters, uppercase letters, underscores and spaces so that all its left with are numbers, parentheses,
                //commas, and other characters. The result is in a pattern of characters that can be used as a unique string to identify the correct target function.
                let funcString = arguments.callee.caller.toString().replace(/[a-zA-Z_ ]/g, '');
                //In the case of the function being attacked, the string below is unique to the target.
                if(funcString.includes('100,50,500,0,300,200')) {
                    console.log(arguments.callee.caller.name);
                    console.log(arguments.callee.caller.toString());
                    console.log(arguments.callee.caller.arguments);
                    photoExploit.photoCaptureFunc_Name = arguments.callee.caller.name;
                    photoExploit.photoCaptureFunc_Found = true;
                    //If the target function has called getImageData, then it calls the original getImageData function using our exploitCanvas and returns the results.
                    return photoExploit.exploitContext.__oldGetImageData(0, 0, w, h);
                } else {
                    //If not the target function, then it calls the original getImageData using the original arguments passed by the calling function.
                    return CanvasRenderingContext2D.prototype.__oldGetImageData.apply(this, arguments);
                }
            }
        };
    },
    //When turned off, the original getImageData is set equal to the original prototype.
    off: function(){
        CanvasRenderingContext2D.prototype.getImageData = CanvasRenderingContext2D.prototype.__oldGetImageData;
    },
    //Prepares the canvas object.
    initialize: function(){
        photoExploit.exploitContext = photoExploit.exploitCanvas.getContext('2d');
        photoExploit.exploitCanvas.width = 184;
        photoExploit.exploitCanvas.height = 124;
        photoExploit.loadImage("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALgAAAB8CAIAAABVKO0yAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAABZSURBVHhe7cEBDQAAAMKg909tDwcEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAiRoL6wABrH+NigAAAABJRU5ErkJggg==");

    }
};
photoExploit.initialize();

//Receives messages from the popup window and processes those messages.
let messageHandler = {
    command: true,
    commandType: 0,
    receiveMessage: function(event){
        if(messageHandler.command){
            switch(event.data){
                case "picture":
                    messageHandler.commandType = 0;
                    messageHandler.command = false;
                    break;
                case "pictureOn":
                    photoExploit.on();
                    break;
                case "pictureOff":
                    photoExploit.off();
                    break;
                default:
            }
        } else {
            switch(messageHandler.commandType){
                case 0:
                    photoExploit.loadImage(event.data);
                    messageHandler.command = true;
                    break;
                default:
            }
        }
    }
};
window.addEventListener("message", messageHandler.receiveMessage, false);

//Popup window containing the UI for this exploit.
let settingsWindow = window.open("", "myWindow", "width=500, height=500");
settingsWindow.document.write('<!DOCTYPE html><html lang="en"><head> <meta charset="UTF-8"> <title>Settings</title> <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"> <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script> <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script> <style>.split-para{display:block}.split-para span{display:block;float:right;}/* The switch - the box around the slider */ .switch{position: relative; display: inline-block; width: 50px; height: 24px;}/* Hide default HTML checkbox */ .switch input{opacity: 0; width: 0; height: 0;}/* The slider */ .slider{position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; -webkit-transition: .4s; transition: .4s;}.slider:before{position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; -webkit-transition: .4s; transition: .4s;}input:checked + .slider{background-color: lawngreen;}input:focus + .slider{box-shadow: 0 0 1px lawngreen;}input:checked + .slider:before{-webkit-transform: translateX(26px); -ms-transform: translateX(26px); transform: translateX(26px);}/* Rounded sliders */ .slider.round{border-radius: 34px;}.slider.round:before{border-radius: 50%;}</style></head><body><div class="panel panel-default" style="width: 500px;"> <div class="panel-heading split-para">Picture Replacer <span><label class="switch"><input id="pictureOnOff" type="checkbox" onclick="pictureOnOff()"><span class="slider round"></span></label></span></div><div class="panel-body"> <p>Replaces pictures taken using the in game camera with the image you have chosen.</p><form> <input type="file" id="myImage" name="filename" accept="image/png, image/jpeg"> </form> <canvas id="canv" width="184" height="124" style="margin-top: 10px; background-color: black; width: 184px; height: 124px;"></canvas> </div></div><script>let canvas=document.getElementById("canv"); let ctx=canvas.getContext("2d"); document.getElementById("myImage").onchange=function (e){var reader=new FileReader(); reader.onload=function(event){var img=new Image(); img.onload=function(){ctx.drawImage(img,0,0, 184, 124); window.opener.postMessage("picture"); window.opener.postMessage(canvas.toDataURL("image/png"))}; img.src=event.target.result;}; try{reader.readAsDataURL(e.target.files[0]);}catch (err){console.log("Failed to get image.")}}; function pictureOnOff(){if (document.getElementById("pictureOnOff").checked){window.opener.postMessage("pictureOn");}else{window.opener.postMessage("pictureOff");}};</script></body></html>');
